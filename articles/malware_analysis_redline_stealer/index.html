<!DOCTYPE html>
<html lang="fr">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    
    <link rel="canonical" href="https://nikj-fr.github.io/articles/malware_analysis_redline_stealer/">
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.98.0" />

    
    
    

<title>Malware Analysis - RedLine Stealer • </title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Malware Analysis - RedLine Stealer"/>
<meta name="twitter:description" content="RedLine Stealer is a low-cost password stealer sold on underground forums. It steals passwords, credit card information and other sensitive data and sends it to a remote location."/>

<meta property="og:title" content="Malware Analysis - RedLine Stealer" />
<meta property="og:description" content="RedLine Stealer is a low-cost password stealer sold on underground forums. It steals passwords, credit card information and other sensitive data and sends it to a remote location." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nikj-fr.github.io/articles/malware_analysis_redline_stealer/" /><meta property="article:section" content="articles" />
<meta property="article:published_time" content="2022-05-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-05-03T00:00:00+00:00" /><meta property="og:site_name" content="Infosec Website | CTF Write Up" />



    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/github.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.7607cf2bc2eb2cb9f7611afe1f814025416b193e2786307b9247d028b5476745.css" integrity="sha256-dgfPK8LrLLn3YRr&#43;H4FAJUFrGT4nhjB7kkfQKLVHZ0U=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://nikj-fr.github.io/">
        
          
        
        </a>
      </span>
      
        
        
        
        <div class="author-image">
          <a href="https://nikj-fr.github.io/">
            <img src="https://nikj-fr.github.io/images/profil.jpg" alt="Author Image" class="img--circle img--headshot element--center">
          </a>
        </div>
        
      
      
      <p class="site__description">
        <a href="https://nikj-fr.github.io/">
           Infosec Website | CTF Write Up 
        </a> 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle"></label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/walkthroughs/">
						<span>Walkthroughs</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/write-ups/">
						<span>Write-Ups</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/cheatsheets/">
						<span>Cheatsheets &amp; Ressources</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/articles/">
						<span>Articles</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About-Me</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/%3cusername%3e" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="https://github.com/Nikj-Fr" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	<a href="https://gitlab.com/Nikj-Fr" rel="me"><i class="fab fa-gitlab fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	
	<a href="mailto:nikj@protonmail.com" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
	
	
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2019 - 2022 Nikj-Fr
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Malware Analysis - RedLine Stealer</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> May 3, 2022
    
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 5 min read
</div>


  </header>
  
  
  <div class="post">
    <h3 id="table-of-content"><strong>Table of content</strong></h3>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#unpacking">Unpacking</a></li>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#c2-communication">C2 Communication</a></li>
<li><a href="#data-collected">Data collected</a></li>
<li><a href="#checks">Checks</a></li>
<li><a href="#browsers">Browsers</a></li>
<li><a href="#ftp-credentials">FTP Credentials</a></li>
<li><a href="#crypto-wallets">Crypto Wallets</a></li>
<li><a href="#credit-cards">Credit Cards</a></li>
<li><a href="#vpn-credentials">VPN Credentials</a></li>
<li><a href="#remote-code-execution">Remote Code Execution</a></li>
<li><a href="#ioc">IoC</a></li>
</ul>
<h3 id="introduction"><strong>Introduction</strong></h3>
<p>Redline Stealer is distributed through Phishing Emails or malicious software disguised as installation files such as Discord or cracked software. 
Recently, Phishing Link that downloads Chrome Extension containing Redline Stealer by abusing YouTube Video Description 
(<a href="https://www.bleepingcomputer.com/news/security/massive-campaign-uses-youtube-to-push-password-stealing-malware/"><em>source</em></a>).</p>
<p>The sample analyzed can be download <a href="https://samples.vx-underground.org/samples/Families/RedLine/Samples/0adb0e2ac8aa969fb088ee95c4a91536.7z">here</a>.<br>
The MD5 is <code>0adb0e2ac8aa969fb088ee95c4a91536</code>.</p>
<h3 id="unpacking"><strong>Unpacking</strong></h3>
<p>This sample is packed, we can see it by looking at the entropy of the binary.</p>
<p><img src="/images/articles/malware_analysis_redline_stealer/Packed_Entropy_Text_Modif.png" alt="entropy"></p>
<p>Futhermore, we can look at the address of the entrypoint to know that the stub is located in the .text section.</p>
<p><img src="/images/articles/malware_analysis_redline_stealer/Packed_Entrypoint.png" alt="stub_entrypoint"></p>
<p>Let&rsquo;s use <a href="https://www.unpac.me/">UnpacMe</a> (up to 10 subscriptions/months with free account) to unpack this malware easily.</p>
<p><img src="/images/articles/malware_analysis_redline_stealer/Unpacked_With_UnpacMe.png" alt="unpacked"></p>
<p>The malware is splitted into 3 stages. We&rsquo;ll deeply analysis the last unpacked stage.</p>
<p>The SHA256 of the sample analyzed is <code>e90f6d0a7b7d0f23d0b105003fce91959c2083c23394b5cf43101c84ae8be4d2</code>.</p>
<h3 id="configuration"><strong>Configuration</strong></h3>
<p>The malware encodes the communication with it&rsquo;s C2 server with a unique key. 
The decryption function <code>Decrypt()</code> is working like:</p>
<ul>
<li>Decode Base 64 strings provided in parameter</li>
<li>Xor the decoded string with the key</li>
<li>Decode the base 64 xored string to retrieve the final string</li>
</ul>
<p><img src="/images/articles/malware_analysis_redline_stealer/decrypt_string_method.png" alt="decrypt_string_method"></p>
<p>The key <code>Pythonic</code> is hardcoded in the <code>EntryPoint</code> constructor class.</p>
<p><img src="/images/articles/malware_analysis_redline_stealer/entrypoint_and_key_value.png" alt="entrypoint_and_key_value"></p>
<p>The following Python script allow the decryption of the RedLine Stealer configuration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>TODO
</span></span></code></pre></div><p>As a result, we have:</p>
<ul>
<li><strong>C2 = 46.8.19.196:53773</strong></li>
<li><strong>Release_Id = ytmaloy8</strong></li>
</ul>
<h3 id="c2-communication"><strong>C2 Communication</strong></h3>
<p>The malware check if a connection flag is set. If not, it doesn&rsquo;t perform any tasks but trying to connect to his C2.</p>
<p><img src="/images/articles/malware_analysis_redline_stealer/check_if_connection_flag_is_set.png" alt="check_if_flag_is_set"></p>
<p>The malware enable the connection with his C2 using <code>RequestConnection()</code> method to <code>http://&quot; + C2 address + &quot;/&quot;</code>.</p>
<p><img src="/images/articles/malware_analysis_redline_stealer/communication_main.png" alt="communication_main"></p>
<p>Once the malware is connected, it try to get the arguments provided by the C2. The <code>ScanningArgs</code> structure is
responsible for storing this configuration.</p>
<p><img src="/images/articles/malware_analysis_redline_stealer/handle_args_in_main.png" alt="handle_args_in_main"></p>
<p>All the arguments provided have a flag (boolean to TRUE or FALSE to enable a capability).</p>
<p><img src="/images/articles/malware_analysis_redline_stealer/args_to_check.png" alt="args_to_check"></p>
<h3 id="data-collected"><strong>Data Collected</strong></h3>
<p>The <code>ScanResult</code> class store the collected information about the infected host.
Each method in this class are obfuscated, some are written in russian.</p>
<p><img src="/images/articles/malware_analysis_redline_stealer/all_collected_data.png" alt="all_collected_data"></p>
<p>Here is a list of collected resources:</p>
<pre tabindex="0"><code>* Graphic Cards information 	(a03md9ajsd)
* All running processus			(ыал8р45)
* Installed browser				(asdk8jasd)
* Scan Chrome / Gecko			(вал93тфыв)
* Total RAM			 			(лыв7рыва2)
* Installed Software			(ылв92р34выа)
* Installed Firewalls			(аловй)
* Machine Name					(sdf934asd)
* Langage / TimeZone / Screen Resolution / OSVersion	(sdfi35sdf)
* Number of processor			(asdk9345asd)
* FTP Credentials				(навева)
* Crypto wallets keys			(ащы9р34)
* Discord 						(ыва83о4тфыв)
* Telegram						(ывал8н34)
* Steam Credentials				(askd435)
* VPN Credentials				(sdi845sa)
* Unique MD5 hash				(asdkadu8)
* File Path Execution			(sdfo8n234)
* File Exfiltration				(вашу0л34)
* Screenshots					(длвап9345)
* Available Langage				(ываш9р34)
</code></pre><h3 id="checks"><strong>Checks</strong></h3>
<h4 id="mutex">Mutex</h4>
<p>The malware use a mutex to know if the victim is already infected by the malware with <code>Program.SeenBefore()</code> method.</p>
<p><img src="/images/articles/malware_analysis_redline_stealer/check_if_already_infected_in_main.png" alt="check_in_main"></p>
<p>This function checks if the folder <code>Yandex\YaAddon</code> is present in <code>C:\Users\&lt;USER_NAME&gt;\AppData\Local</code></p>
<p><img src="/images/articles/malware_analysis_redline_stealer/check_if_already_infected.png" alt="mutex"></p>
<h4 id="location">Location</h4>
<p>Inside <code>ResultFactory.AKSFD8H23()</code>, the malware get IP of the target and use GeoIP API to retrieve the location, Country of the victim.
Next, it checks if the values returned from GeoIP are black listed (<code>ScanningArgs.blockedCountry</code>)</p>
<p><img src="/images/articles/malware_analysis_redline_stealer/check_location.png" alt="check_location"></p>
<p>Here the malware gets the location, IP, and country and checks if it is located in the black list. If yes, malware does nothing and exit.</p>
<h3 id="browsers"><strong>Browsers</strong></h3>
<p>The collected information about installed browsers is done in <code>SystemInfoHelper.GetBrowsers()</code>.</p>
<p><img src="/images/articles/malware_analysis_redline_stealer/browser_code.png" alt="browser_code"></p>
<p>It collects the name of the browser, the full path and the version.</p>
<p>Next, it search for Chrome based browsers. 
This time, it will collect more information such as Logins, Cookies, Autofills data.</p>
<p><img src="/images/articles/malware_analysis_redline_stealer/data_for_each_browser.png" alt="data_browser"></p>
<p>The malware is doing the same for Gecko based browser.</p>
<h3 id="ftp-credentials"><strong>FTP Credentials</strong></h3>
<p>The malware collect FTP credentials by searching in paths:</p>
<ul>
<li><code>C:\Users\&lt;USER_NAME&gt;\AppData\Local\FileZilla\recentservers.xml</code></li>
<li><code>C:\Users\&lt;USER_NAME&gt;\AppData\Local\FileZilla\sitemanager.xml</code></li>
</ul>
<p><img src="/images/articles/malware_analysis_redline_stealer/filezilla_code.png" alt="filezilla_steal"></p>
<p>If the files exists, it will extract account credentials such as:</p>
<ul>
<li>Host</li>
<li>Port</li>
<li>User</li>
<li>Password</li>
</ul>
<p>The extraction process is to look for each XML node if it match with Host, Port, User or Pass 
and fed it&rsquo;s equivalent attribute with the value returned.</p>
<p><img src="/images/articles/malware_analysis_redline_stealer/filezilla_scan_for_each_nodes.png" alt="filezilla_scan_for_each_nodes"></p>
<h3 id="crypto-wallets"><strong>Crypto Wallets</strong></h3>
<p>Hot wallet purpose is to store the public and private key in your browser. 
To perform any transaction in the crypto space you need your private key. 
That&rsquo;s why hackers try to steal it from you.</p>
<p>The <code>BrowserExtensionRule</code> class is searching for wallet extension like:</p>
<ul>
<li>Metamask</li>
<li>Coinbase</li>
<li>BinanceChain</li>
<li>iWallet</li>
</ul>
<p><img src="/images/articles/malware_analysis_redline_stealer/crypto_wallet_rules.png" alt="crypto_wallet"></p>
<h3 id="credit-cards"><strong>Credit Cards</strong></h3>
<p>The <code>CC</code> class purpose is to steal credit cards information from the victim:</p>
<ul>
<li>Owner Name</li>
<li>Expiration Month</li>
<li>Expiration Year</li>
<li>PIN Number</li>
</ul>
<p><img src="/images/articles/malware_analysis_redline_stealer/credit_card_get_info.png" alt="credit_cards"></p>
<p>It is looking up in the <code>LocalPrefs.json</code> file of Chrome and Gecko browser, to find saved credit card information.</p>
<p><img src="/images/articles/malware_analysis_redline_stealer/credit_card_file.png" alt="credit_cards_file"></p>
<h3 id="vpn-credentials"><strong>VPN Credentials</strong></h3>
<p>The malware tries to collect <code>NordVPN</code>, <code>OpenVPN</code>, <code>ProtonVPN</code>.<br>
For OpenVPN, the class <code>OpenVPNRule()</code> search for XML file which contains the credentials. 
And so for ProtonVPN uses <code>ProtonVPNRule()</code> to search for protonVPN credentials.</p>
<p><img src="/images/articles/malware_analysis_redline_stealer/vpn_rules.png" alt="vpn_rules"></p>
<p>I&rsquo;ll take the example of <code>ProtonVPNRule</code> (the purpose is the same for OpenVPN).
The malware is looking for <code>ProtonVPN</code> folder in <code>C:\Users\&lt;USER_NAME&gt;\AppData\Local</code>.
Inside the ProtonVPN folder it will search for the pattern <strong>&quot;*ovpn&quot;</strong> which is the file extension containing connection credentials.</p>
<p><img src="/images/articles/malware_analysis_redline_stealer/proton_vpn_steal.png" alt="protonvpn_steal"></p>
<h3 id="remote-code-execution"><strong>Remote Code Execution</strong></h3>
<p>The malware use command line with <code>cmd /C &lt;ACTION&gt;</code> to execute code remotely.</p>
<p><img src="/images/articles/malware_analysis_redline_stealer/rce_cmd.png" alt="rce_cmd"></p>
<p>It can drop malicious files with <code>DownloadUpdate()</code> method, and executes it with <code>DownloadAndExecuteUpdate()</code></p>
<h3 id="ioc"><strong>IoC</strong></h3>
<pre tabindex="0"><code>* C2 = 46[.]8[.]19[.]196[:]53773
* Release ID = ytmaloy8
* Xor Key = Pythonic
* Packed stage 1 sample MD5 = 0adb0e2ac8aa969fb088ee95c4a91536
* Packed stage 2 sample SHA256 = 97cdde692fadbb6d04dc59ba21e3f41b186810ee8962c6d3d2d33292ef4085d7
* Unpacked stage 3 SHA256 = e90f6d0a7b7d0f23d0b105003fce91959c2083c23394b5cf43101c84ae8be4d2
* Mutex = C:\Users\&lt;USER_NAME&gt;\AppData\Local\Yandex\YaAddon
</code></pre><h3 id="references"><strong>References</strong></h3>
<ul>
<li>[1] <a href="https://www.bitdefender.com/files/News/CaseStudies/study/415/Bitdefender-PR-Whitepaper-RedLine-creat6109-en-EN.pdf">https://www.bitdefender.com/files/News/CaseStudies/study/415/Bitdefender-PR-Whitepaper-RedLine-creat6109-en-EN.pdf</a></li>
<li>[2] <a href="https://medium.com/s2wblog/deep-analysis-of-redline-stealer-leaked-credential-with-wcf-7b31901da904">https://medium.com/s2wblog/deep-analysis-of-redline-stealer-leaked-credential-with-wcf-7b31901da904</a></li>
<li>[3] <a href="https://www.bleepingcomputer.com/news/security/massive-campaign-uses-youtube-to-push-password-stealing-malware/">https://www.bleepingcomputer.com/news/security/massive-campaign-uses-youtube-to-push-password-stealing-malware/</a></li>
<li>[4] <a href="https://www.unpac.me/#/">https://www.unpac.me/#/</a></li>
</ul>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/articles/setup_remote_kernel_debugging/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Tutorial - Setup Remote Kernel Debugging</span>
    </a>
    
    
</div>


  

  
    


</article>


        </div>
        
    

<script defer src="https://use.fontawesome.com/releases/v5.12.1/js/all.js" integrity="sha384-ZbbbT1gw3joYkKRqh0kWyRp32UAvdqkpbLedQJSlnI8iLQcFVxaGyrOgOJiDQTTR" crossorigin="anonymous"></script>


    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
        
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    



    



    </body>
</html>
