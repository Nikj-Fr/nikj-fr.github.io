<!DOCTYPE html>
<html lang="fr">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.74.1" />

    
    
    

<title>Practical Malware Analysis - Lab 5 • </title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Practical Malware Analysis - Lab 5"/>
<meta name="twitter:description" content="Troisième exercice pratique du livre Practical Malware Analysis"/>

<meta property="og:title" content="Practical Malware Analysis - Lab 5" />
<meta property="og:description" content="Troisième exercice pratique du livre Practical Malware Analysis" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nikj-fr.github.io/walkthroughs/pma_lab5/" />
<meta property="article:published_time" content="2020-12-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-12-28T00:00:00+00:00" /><meta property="og:site_name" content="Nikj | Personal Website" />


    








<link rel="stylesheet" href="/scss/hyde-hyde.d0c4ffb2e1828bd88212c4246b2911d84b93350f28f2d499f40bb11f1bd57e9a.css" integrity="sha256-0MT/suGCi9iCEsQkaykR2EuTNQ8o8tSZ9AuxHxvVfpo=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://nikj-fr.github.io/"></a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://nikj-fr.github.io/images/profil.jpg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         InfoSec Website | CTF WriteUp 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle"></label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/walkthroughs/">
						<span>Walkthroughs</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/writeup/">
						<span>Write-Ups</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/cheatsheets/">
						<span>Cheatsheets &amp; Ressources</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/articles/">
						<span>Articles</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About-Me</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/%3cusername%3e" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://github.com/Nikj-Fr" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	<a href="https://gitlab.com/Nikj-Fr" rel="me"><i class="fab fa-gitlab fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	<a href="mailto:jallet.nicolas16@gmail.com" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://www.root-me.org/Nikj"></a><div class="root-me"></div></a>
	
	
	<a href="https://www.tryhackme.com/"></a><div class="tryhackme"></div></a>
	
	
	<a href="https://www.hackthebox.eu/"></a><div class="hackthebox"></div></a>
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2019 - 2020 htr3n
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Practical Malware Analysis - Lab 5</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Dec 28, 2020
    
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 4 min read
</div>


  </header>
  
  
  <div class="post">
    <h2 id="discover-ida-pro"><strong>Discover IDA Pro</strong></h2>
<h3 id="lab-5"><strong>Lab 5</strong></h3>
<p>This lab use the file Lab05-01.dll. It has to be analyze only on IDA Pro. This is our first experience with this tool.</p>
<h4 id="what-is-the-address-of-dllmain-"><strong>What is the address of DllMain ?</strong></h4>
<p>The address of DllMain can be find in the <em>Functions Windows</em> by default on the left side of your screen.It starts at <strong>0x1000D02E</strong>.</p>
<p><img src="/images/walkthroughs/pma_lab5/lab-5-1_start_address.png" alt="start_address"></p>
<p>Also, you can visualize it on the Graph View by turning on <em>Line Prefixes</em> in the settings. For me it was already checked.</p>
<p><img src="/images/walkthroughs/pma_lab5/lab-5-1_start_address2.png" alt="start_address2"></p>
<h4 id="use-the-imports-window-to-browse-to-gethostbyname-where-is-the-import-located-"><strong>Use the Imports window to browse to <em>gethostbyname</em>. Where is the Import located ?</strong></h4>
<p>If the <em>Import Windows</em> isn&rsquo;t enable by default. You can show it by clicking on View -&gt; Opensubviews -&gt; Imports</p>
<p>The imports address of that function is <strong>0x100163CC</strong>.</p>
<p><img src="/images/walkthroughs/pma_lab5/lab-5-2_imports.png" alt="imports"></p>
<h4 id="how-many-functions-call-gethostbyname-"><strong>How many functions call <em>gethostbyname</em> ?</strong></h4>
<p>In order to see where the <em>gethostbyname</em> functions is call we use Cross-reference. To open the all the cross-reference of this function, you have to use the shortcut <strong>CTRL + X</strong> once the name is highlighted.</p>
<p>It should open this windows and list all the references.</p>
<p><img src="/images/walkthroughs/pma_lab5/lab-5-3_xref.png" alt="xrefs"></p>
<p>There are 18 calls of this function made by 5 differents subroutines.</p>
<h4 id="focusing-on-the-call-to-gethostbyname-located-at-0x10001757-can-you-figure-out-which-dns-request-will-be-made-"><strong>Focusing on the call to gethostbyname located at 0x10001757, can you figure out which DNS request will be made ?</strong></h4>
<p>We jump to the address mentionned in the question with the <em>jump to address setting</em>.</p>
<p><img src="/images/walkthroughs/pma_lab5/lab-5-4_jump_dns.png" alt="jump"></p>
<p>Here we are.</p>
<p><img src="/images/walkthroughs/pma_lab5/lab-5-4_dns.png" alt="jump"></p>
<p>Before the execution of the function we can see that a strings is moved in the EAX register. The strings is: &ldquo;<em>[This is RDO]pics.practicalmalwareanalysis.com</em>&rdquo;. The comma with the &ldquo;0&rdquo; is here to indicate a NULL Byte. This byte is used by the system to know when the string end.</p>
<p><img src="/images/walkthroughs/pma_lab5/lab-5-4_strings_dns.png" alt="strings"></p>
<p>Then there is the operand <em>ADD</em> with the parameter <em>0Dh</em>. The parameter is an hexadecimal value. We convert it in base10 and see that this number is 13. In other words, 13 bytes will be added to the EAX pointer. The new string start from: &ldquo;<em>pics.practicalmalwareanalysis.com</em>&rdquo;. This is the real address that the domain will have to resolv.</p>
<p>After that the EAX register is push on the stack to be used by the <em>gethostbyname</em> function in order to make the call.</p>
<h4 id="how-many-local-variables-has-ida-pro-recognized-for-the-subroutine-at-0x10001656-"><strong>How many local variables has IDA Pro recognized for the subroutine at 0x10001656 ?</strong></h4>
<p>Let&rsquo;s jump to 0x10001656.
Here we can see 23 local variables. There are created with a negative ptr indicate a variable. Otherwise,positive content mean a parameter of the function.</p>
<p><img src="/images/walkthroughs/pma_lab5/lab-5-5_variables.png" alt="local_variables"></p>
<h4 id="how-many-parameters-has-ida-pro-recognized-for-the-subroutine-at-0x1001656-"><strong>How many parameters has IDA Pro recognized for the subroutine at 0x1001656 ?</strong></h4>
<p>As we said previously, we can count only one positive value. There is only 1 parameter on this function.</p>
<p><img src="/images/walkthroughs/pma_lab5/lab-5-6_parameter.png" alt="parameter"></p>
<h4 id="use-the-strings-windows-to-locate-the-string-cmdexe-in-the-disassembly-where-is-it-located-">*<strong>Use the Strings windows to locate the string &ldquo;cmd.exe&rdquo; in the disassembly. Where is it located ?</strong></h4>
<p>View -&gt; Opensubviews -&gt; Strings</p>
<p>The strings &ldquo;<em>cmd.exe</em>&rdquo; is located at <strong>0x10095B34</strong>.</p>
<p><img src="/images/walkthroughs/pma_lab5/lab-5-7_cmd.png" alt="cmd"></p>
<h4 id="what-is-happening-in-the-area-of-code-that-references-cmdexe-"><strong>What is happening in the area of code that references &ldquo;cmd.exe&rdquo; ?</strong></h4>
<p>We follow the cross-reference to see where the string is use.</p>
<p><img src="/images/walkthroughs/pma_lab5/lab-5-8_cmd_use.png" alt="cmd_use"></p>
<p>The string is pushed on top of the stack to be use by a command line function. This is used to open the terminal.</p>
<p>If we go down a little bit we can see other strings like &ldquo;quit, exit, cd&rdquo;</p>
<p><img src="/images/walkthroughs/pma_lab5/lab-5-8_strings2.png" alt="strings2"></p>
<p>Then let&rsquo;s go back to the <em>text view</em> where we saw new strings.
They looks like automatic &ldquo;welcome&rdquo; for the owner of the malware. Futhermore, we can read a &ldquo;<em>creating a reverse shell session</em>&rdquo;. This is probably how the attacker persist on the computer of his victim.</p>
<p><img src="/images/walkthroughs/pma_lab5/lab-5-8_strings3.png" alt="strings3"></p>
<h4 id="in-the-same-area-at-0x100101c8-it-looks-like-dword_1008e5c4-is-a-global-variable-that-helps-decide-which-path-to-take-how-does-the-malware-set-dword_1008e5c4-"><strong>In the same area, at 0x100101C8, it looks like dword_1008E5C4 is a global variable that helps decide which path to take. How does the malware set dword_1008E5C4 ?</strong></h4>
<h4 id="a-few-hundred-lines-into-the-subroutine-at-0x1000ff58-a-series-of-comparisons-use-memcmp-to-compare-strings-what-happens-if-the-string-comparison-to-robotwork-is-successfull-"><strong>A few hundred lines into the subroutine at 0x1000FF58, a series of comparisons use memcmp to compare strings. What happens if the string comparison to robotwork is successfull ?</strong></h4>
<h4 id="what-does-the-export-pslist-do-"><strong>What does the export PSLIST do ?</strong></h4>
<h4 id="use-the-graph-mode-to-graph-the-cross-reference-from-sub_10004379-which-api-functions-could-be-called-by-entering-this-function--based-on-the-api-functions-alone-what-could-you-rename-this-function-"><strong>Use the graph mode to graph the cross-reference from sub_10004379. Which API functions could be called by entering this function ? Based on the API functions alone, what could you rename this function ?</strong></h4>
<h4 id="how-many-windows-api-functions-does-dllmain-call-directly--how-many-at-a-depth-of-2-"><strong>How many Windows API functions does DllMain call directly ? How many at a depth of 2 ?</strong></h4>
<h4 id="at-0x10001358-there-is-a-call-to-sleep-looking-backward-though-the-code-how-long-will-the-program-sleep-if-this-code-executes-"><strong>At 0x10001358, there is a call to Sleep. Looking backward though the code, how long will the program sleep if this code executes ?</strong></h4>
<h4 id="at-0x10001701-is-a-call-to-socket-what-are-the-three-parameters-"><strong>At 0x10001701 is a call to socket. WHat are the three parameters ?</strong></h4>
<h4 id="using-the-msdn-page-for-socket-and-the-named-symbolic-constants-functionality-in-ida-pro-can-you-make88-what-do-you-find-"><strong>Using the MSDN page for socket and the named symbolic constants functionality in IDA Pro, can you make88. What do you find ?</strong></h4>
<h4 id="if-you-have-the-ida-python-plug-in-installed-run-lab05-01py-an-ida-pro-python-script-provided-with-the-malware-for-this-book-what-happens-after-you-run-the-script-"><strong>If you have the IDA Python plug-in installed, run Lab05-01.py, an IDA Pro Python script provided with the malware for this book. What happens after you run the script ?</strong></h4>
<h4 id="with-the-cursor-in-the-same-location-how-do-you-turn-this-data-into-a-single-ascii-string-"><strong>With the cursor in the same location, how do you turn this data into a single ASCII string ?</strong></h4>
<h4 id="open-the-script-with-a-text-editor-how-does-it-work-"><strong>Open the script with a text editor. How does it work ?</strong></h4>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/walkthroughs/pma_lab3/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Practical Malware Analysis - Lab 3</span>
    </a>
    
    
</div>


  

  
    


</article>


        </div>
        
    

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'your-google-analytics-id', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.11.2/js/all.js" integrity="sha384-b3ua1l97aVGAPEIe48b4TC60WUQbQaGi2jqAWM90y0OZXZeyaTCWtBTKtjW2GXG1" crossorigin="anonymous"></script>




    



    </body>
</html>
