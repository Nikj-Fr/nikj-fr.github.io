<!DOCTYPE html>
<html lang="fr">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.78.2" />

    
    
    

<title>Practical Malware Analysis - Lab 1 • </title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Practical Malware Analysis - Lab 1"/>
<meta name="twitter:description" content="Premier exercice pratique du livre Practical Malware Analysis"/>

<meta property="og:title" content="Practical Malware Analysis - Lab 1" />
<meta property="og:description" content="Premier exercice pratique du livre Practical Malware Analysis" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://nikj-fr.github.io/walkthroughs/pma_lab1/" />
<meta property="article:published_time" content="2020-12-05T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-12-05T00:00:00+00:00" /><meta property="og:site_name" content="Nikj | Personal Website" />


    








<link rel="stylesheet" href="/scss/hyde-hyde.d0c4ffb2e1828bd88212c4246b2911d84b93350f28f2d499f40bb11f1bd57e9a.css" integrity="sha256-0MT/suGCi9iCEsQkaykR2EuTNQ8o8tSZ9AuxHxvVfpo=">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://nikj-fr.github.io/"></a>
      </span>
      
        
        
        
        <div class="author-image">
          <img src="https://nikj-fr.github.io/images/profil.jpg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
         InfoSec Website | CTF WriteUp 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle"></label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/walkthroughs/">
						<span>Walkthroughs</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/writeup/">
						<span>Write-Ups</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/cheatsheets/">
						<span>Cheatsheets &amp; Ressources</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/articles/">
						<span>Articles</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About-Me</span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/%3cusername%3e" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://github.com/Nikj-Fr" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	<a href="https://gitlab.com/Nikj-Fr" rel="me"><i class="fab fa-gitlab fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	
	
	
	<a href="mailto:jallet.nicolas16@gmail.com" rel="me"><i class="fas fa-at fa-lg" aria-hidden="true"></i></a>
	
	
	<a href="https://www.root-me.org/Nikj"></a><div class="root-me"></div></a>
	
	
	<a href="https://www.tryhackme.com/"></a><div class="tryhackme"></div></a>
	
	
	<a href="https://www.hackthebox.eu/"></a><div class="hackthebox"></div></a>
	
</section>

      </div>
    </div>
    
<div class="copyright">
  &copy; 2019 - 2020 htr3n
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>


<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    
<article>
  <header>
    <h1>Practical Malware Analysis - Lab 1</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Dec 5, 2020
    
    
    
    
    
    <br/>
    <i class="fas fa-clock"></i> 4 min read
</div>


  </header>
  
  
  <div class="post">
    <h4 id="lab-1-1">Lab 1-1</h4>
<p>This lab uses the files Lab01-01.exe and Lab01-01.dll.</p>
<h3 id="upload-the-files-to-httpwwwwvirustotalcom-and-view-the-reports-does-either-file-match-any-existing-antivirus-signature-"><strong>Upload the files to <a href="http://wwww.VirusTotal.com/">http://wwww.VirusTotal.com/</a> and view the reports. Does either file match any existing antivirus signature ?</strong></h3>
<p>a) Lab01-01.exe<br>
Virus Total a détecté un potentiel <em>Trojan</em>.<br>
La signature du malware (MD5) est: <em>bb7425b82141a1c0f7d60e5106676bb1</em></p>
<p><strong>50/70</strong> antivirus positifs</p>
<p>b) Lab01-01.dll<br>
La signature est: <em>290934c61de9176ad682ffdd65f0a669</em></p>
<p><strong>42/67</strong> antivirus positifs</p>
<p>Les signatures des malwares peuvent être généré grâce à WinMD5 en lui fournissant le binaire.</p>
<h3 id="when-were-these-files-compiled-"><strong>When were these files compiled ?</strong></h3>
<p>Les binaires ont été compilé le 19/12/2010 à 16h16</p>
<h3 id="are-there-any-indications-that-either-of-these-files-is-packed-or-obfuscated-if-so-what-are-these-indicators-"><strong>Are there any indications that either of these files is packed or obfuscated if so, what are these indicators ?</strong></h3>
<p>a) PEiD<br>
Nous lançons le logiciel PEiD pour voir si Qles fichiers sont packés.
Le logiciel détecte que l&rsquo;executable et la dll ont été compilé à l&rsquo;aide de Microsoft Visual C++ 6.0.<br>
Pour le moment nous ne voyons pas de traces evidentes d&rsquo;un packer.</p>
<p><img src="/images/walkthroughs/pma_lab1/lab-1-1_3_peid.png" alt="image_peid"></p>
<p>b) Dependencies Walker</p>
<p>Trois DLL sont utilisés par le malware, les fonctions importées par celles-ci ne sont pas obfusqués.</p>
<ul>
<li>KERNEL32.DLL</li>
<li>MSVCRT.DLL</li>
</ul>
<p><img src="/images/walkthroughs/pma_lab1/lab-1-1_3_dll_exe.png" alt="image_exe"></p>
<ul>
<li>WS2_32.DLL</li>
</ul>
<p><img src="/images/walkthroughs/pma_lab1/lab-1-1_3_dll.png" alt="image_dll"></p>
<p>c) PEView</p>
<p>PEView va nous permettre de regarder dans chacune des sections du PE si la taille virtuelle en mémoire est proche de sa taille sur le disque.<br>
Si la taille en mémoire est beaucoup plus grande que la taille sur le disque alors nous avons affaire à un programme paqué.</p>
<table>
<thead>
<tr>
<th>Section</th>
<th>Virtual Size</th>
<th>Size of raw data</th>
</tr>
</thead>
<tbody>
<tr>
<td>.text</td>
<td>1000</td>
<td>970</td>
</tr>
<tr>
<td>.rdata</td>
<td>2B2</td>
<td>1000</td>
</tr>
<tr>
<td>.data</td>
<td>FC</td>
<td>1000</td>
</tr>
</tbody>
</table>
<p>La taille en mémoire n&rsquo;est pas plus grande que la taille sur le disque.
On en déduit que le malware n&rsquo;est pas paqué.</p>
<h3 id="do-any-imports-hint-at-what-this-malware-does--if-so-which-imports-are-they-"><strong>Do any imports hint at what this malware does ? If so, which imports are they ?</strong></h3>
<p>On utilise Dependencies Walker pour lister les fonctions importées.
Quelques fonctions peuvent être intéressantes pour un malware parmis celles importées:</p>
<ul>
<li>CreateFileA (Création d&rsquo;un fichier)</li>
<li>CopyFileA (Copie d&rsquo;un fichier)</li>
<li>FindFirstFileA (listing de répertoire)</li>
<li>FindNextFileA (listing de répertoire)</li>
</ul>
<p><img src="/images/walkthroughs/pma_lab1/lab-1-1_4_import_exe.png" alt="image_import_exe"></p>
<p>Dans la DLL il y a aussi des fonctions intéressantes:</p>
<ul>
<li>connect</li>
<li>closesocket</li>
<li>recv</li>
<li>send</li>
</ul>
<p><img src="/images/walkthoughs/pma_lab1/lab-1-1_4_import_dll.png" alt="image_import_dll"></p>
<h3 id="are-there-any-other-files-or-host-based-indicators-that-you-could-look-on-infected-systems-"><strong>Are there any other files or host-based indicators that you could look on infected systems ?</strong></h3>
<p>En utilisant la commande strings sur l&rsquo;executable on se rend compte que le malware utilise une DLL autre que Kernel32. En effet, il s&rsquo;agit de Kerne123. Le l a été remplacé par un 1.</p>
<p><img src="/images/walkthroughs/pma_lab1/lab-1-1_5_strings_kerne123.png" alt="strings_kerne123"></p>
<h3 id="what-network-based-indicators-could-be-used-to-find-this-malware-on-infected-machines-"><strong>What network-based indicators could be used to find this malware on infected machines ?</strong></h3>
<p>On réalise la même commande mais sur la dll cette fois. On s&rsquo;est rendu compte dans la partie 4 que la DLL était utilisée pour effectuer des commandes réseaux.</p>
<p>On récupère une adresse IP que l&rsquo;on peut considérer comme celle que l&rsquo;attaquant utilise pour communiquer avec le malware.</p>
<p><img src="/images/walkthroughs/pma_lab1/lab-1-1_6_strings_dll.png" alt="strings_dll"></p>
<h3 id="what-would-you-guess-is-the-purpose-of-these-files-"><strong>What would you guess is the purpose of these files ?</strong></h3>
<p>L&rsquo;executable va permettre d&rsquo;installer une DLL backdoor appelé <em>Kerne123.dll</em> qui va pouvoir communiquer avec son Command And Control (C2) à l&rsquo;adresse <em>127.26.152.13</em>.</p>
<h4 id="lab-1-2">Lab 1-2</h4>
<p>This lab uses the files Lab01-02.exe.</p>
<h3 id="upload-the-file-to-httpwwwwvirustotalcom-does-it-match-any-existing-antivirus-definitions-"><strong>Upload the file to <a href="http://wwww.VirusTotal.com/">http://wwww.VirusTotal.com/</a>. Does it match any existing antivirus definitions ?</strong></h3>
<p>Virus Total a détecté un potentiel <em>Trojan</em>.<br>
La signature du malware (MD5) est: <em>8363436878404da0ae3e46991e355b83</em></p>
<p><strong>55/71</strong> antivirus positifs</p>
<h3 id="are-there-any-indications-that-this-file-is-packed-or-obfuscated--if-so-what-are-these-indicators--if-the-file-is-packed-unpack-it-if-possible"><strong>Are there any indications that this file is packed or obfuscated ? If so, what are these indicators ? If the file is packed, unpack it if possible.</strong></h3>
<p>Pour voir si un binaire est paqué, on va utiliser PEiD.
Le binaire a été paqué avec UPX dans sa version 0.89.6.</p>
<p><img src="/images/walkthroughs/pma_lab1/lab-1-2_2_packed_binary.png" alt="packed_binary"></p>
<p>Pour dépaqué ce binaire, on va donc utiliser UPX avec le paramètre <strong>-d</strong> pour depack.</p>
<p><a href="https://sourceforge.net/projects/upx/">Téléchargement UPX</a></p>
<p><img src="/images/walkthroughs/pma_lab1/lab-1-2_2_unpacked_binary.png" alt="unpack_binary"></p>
<p>Le malware n&rsquo;est plus paqué, on peut le vérifier en listant les chaînes de caractères présent dans la binaire ou en relançant PEiD.</p>
<h3 id="do-any-imports-hint-at-this-programs-functionality--if-so-which-imports-are-they-and-what-do-they-tell-you-"><strong>Do any imports hint at this program&rsquo;s functionality ? If so, which imports are they and what do they tell you ?</strong></h3>
<p>Pour regarder les imports réalisés par le malware on va utiliser <em>Dependencies Walker</em></p>
<p><img src="/images/walkthroughs/pma_lab1/lab-1-2_3_import_dll.png" alt="import_dll"></p>
<p>ADVAPI32.DLL</p>
<ul>
<li>CreateServiceA</li>
<li>StartServiceCtrlDispatcherA</li>
<li>OpenSCManagerA</li>
</ul>
<p><img src="/images/walkthroughs/pma_lab1/lab-1-2_3_import_functions_advapi32.png" alt="imports_functions_advapi32"></p>
<p>WININET.DLL</p>
<ul>
<li>InternetOpenUrlA</li>
<li>InternetOpenA</li>
</ul>
<p><img src="/images/walkthroughs/pma_lab1/lab-1-2_3_import_functions_wininet.png" alt="imports_functions_wininet"></p>
<p>D&rsquo;après les fonctions utilisés, on peut déduire que le malware crée un service qu&rsquo;il va connecter à Internet.</p>
<h3 id="what-host-or-network-based-indicators-could-be-used-to-identify-this-malware-on-infected-machines-"><strong>What host or network-based indicators could be used to identify this malware on infected machines ?</strong></h3>
<p>On peut lister les chaînes de caractères du binaire pour voir si l&rsquo;URL à laquelle le service se connecte est clairement indiqué.<br>
On découvre que le service crée est appelé <em>MalService</em> et que le malware se connecte à <em><a href="http://malwareanalysisbook.com">http://malwareanalysisbook.com</a></em></p>
<p><img src="/images/walkthroughs/pma_lab1/lab-1-2_4_strings.png" alt="strings"></p>
<p>On peut retrouver ces informations sous IDA:</p>
<p><img src="/images/walkthroughs/pma_lab1/lab-1-2_4_ida_service.png" alt="ida_service">
<img src="/images/walkthroughs/pma_lab1/lab-1-2_4_ida_url.png" alt="ida_url"></p>
<p>Les labs 3, 4 ne seront pas détaillés car la méthode de résolution reste la même que pour les labs 1 et 2.</p>
<p><strong>PS:</strong> Dans le lab 3, il n&rsquo;est pas possible de dépaquer le malware avec les outils / techniques enseignés a cette période du livre.</p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/walkthroughs/google_dork/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Google Dork</span>
    </a>
    
    
</div>


  

  
    


</article>


        </div>
        
    

  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'your-google-analytics-id', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<script defer src="https://use.fontawesome.com/releases/v5.11.2/js/all.js" integrity="sha384-b3ua1l97aVGAPEIe48b4TC60WUQbQaGi2jqAWM90y0OZXZeyaTCWtBTKtjW2GXG1" crossorigin="anonymous"></script>




    



    </body>
</html>
